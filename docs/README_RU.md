# Контроллер освещения RC

[English](../README.md) | [Polski](README_PL.md) | [Deutsch](README_DE.md) | [Francais](README_FR.md) | **Русский** | [Українська](README_UA.md)

Беспроводной контроллер освещения для RC-автомобилей и грузовиков. Ручной пульт с сенсорным экраном (TX) связывается через ESP-NOW с приёмником (RX), установленным на модели, для управления несколькими световыми выходами в реальном времени.

## Возможности

- **5 независимых световых каналов**: ближний свет, дальний свет, противотуманные фары, световая балка, аварийная сигнализация
- **Сенсорный интерфейс**: сетка кнопок 2x3 на цветном дисплее 1,47" с LVGL
- **Беспроводная связь ESP-NOW**: протокол с низкой задержкой — WiFi-роутер не нужен
- **Автоматическое сопряжение**: сопряжение одной кнопкой с сохранением в NVS
- **Блокировки безопасности**: дальний свет требует включённого ближнего; аварийный режим выключает все огни через 30 с без сигнала
- **Мониторинг соединения**: heartbeat-ы, подтверждение команд через ACK, статусный NeoPixel
- **Тестовый режим**: контроллер работает автономно без приёмника

## Оборудование

### Контроллер (TX)

| Компонент | Описание |
|-----------|----------|
| Плата | [Waveshare ESP32-C6-Touch-LCD-1.47-M](https://www.waveshare.com/wiki/ESP32-C6-Touch-LCD-1.47) |
| MCU | ESP32-C6 (RISC-V, 8 МБ flash) |
| Дисплей | 1,47" JD9853, 172x320, повёрнут в 320x172 альбомную ориентацию |
| Тач | AXS5106L ёмкостный (I2C @ 0x63) |
| Статусный LED | WS2812 NeoPixel на GPIO8 |

### Приёмник (RX)

| Компонент | Описание |
|-----------|----------|
| Плата | Любая плата ESP32 (классический Xtensa) |
| Световые выходы | 5x GPIO, активный-ВЫСОКИЙ |
| Статусный LED | Встроенный LED на GPIO2 |
| Сопряжение | Кнопка BOOT (GPIO0) — удерживать при включении |

### Подключение приёмника

Подключите GPIO ESP32 к вашим огням через подходящие драйверы (MOSFET-ы, реле или LED-драйверы) в зависимости от напряжения и тока. Все выходы активны при высоком уровне (логика 3,3 В).

| GPIO | Функция |
|------|---------|
| 16 | Противотуманные фары |
| 17 | Ближний свет |
| 18 | Дальний свет |
| 19 | Световая балка |
| 21 | Аварийная сигнализация |
| 2 | Статусный LED |
| 0 | Кнопка сопряжения (BOOT) |

## Сборка и прошивка

### Требования

- [PlatformIO](https://platformio.org/) (CLI или плагин для IDE)
- USB-кабели для обеих плат

### Сборка

```bash
# Сборка прошивки контроллера (TX)
pio run -e controller

# Сборка прошивки приёмника (RX)
pio run -e receiver
```

### Прошивка

```bash
# Прошить контроллер
pio run -e controller -t upload

# Прошить приёмник
pio run -e receiver -t upload
```

### Последовательный монитор

```bash
pio device monitor    # 115200 бод
```

## Сопряжение

1. Включите **приёмник**, удерживая **кнопку BOOT** (GPIO0). Статусный LED мигнёт 3 раза, подтверждая режим сопряжения.
2. На **контроллере** откройте **Настройки** и нажмите **Начать сопряжение**.
3. Устройства обмениваются MAC-адресами через ESP-NOW broadcast и сохраняют их в NVS.
4. Перезагрузите оба устройства. Сопряжение сохраняется и переживает перезагрузки.

## Протокол

Связь использует ESP-NOW с упакованными C-структурами (`__attribute__((packed))`) для кросс-архитектурной совместимости (RISC-V контроллер / Xtensa приёмник).

| Сообщение | Направление | Назначение |
|-----------|-------------|------------|
| `LightCommand` | TX -> RX | Задать состояние огней (5-битная маска) |
| `LightAck` | RX -> TX | Подтвердить текущее состояние |
| `Heartbeat` | RX -> TX | Поддержание связи (каждые 2 с) |
| `StateReport` | RX -> TX | Полное состояние + время работы |
| `PairRequest` | TX -> RX | Запрос сопряжения (broadcast) |
| `PairResponse` | RX -> TX | Ответ сопряжения с MAC |

### Битовая маска огней

| Бит | Свет |
|-----|------|
| 0 | Противотуманные фары |
| 1 | Ближний свет |
| 2 | Дальний свет |
| 3 | Световая балка |
| 4 | Аварийная сигнализация |

### Тайминги

| Параметр | Значение |
|----------|----------|
| Таймаут ACK | 200 мс |
| Макс. повторов | 3 |
| Интервал heartbeat | 2 с |
| Таймаут соединения (TX) | 6 с |
| Таймаут аварийного режима (RX) | 30 с |

## Структура проекта

```
light_controller/
├── src/
│   ├── controller/      # TX: дисплей, тач, LVGL UI, ESP-NOW TX
│   └── receiver/        # RX: GPIO-выходы, ESP-NOW RX, аварийный режим
├── lib/
│   ├── protocol/        # Общие определения протокола
│   └── axs5106l_touch/  # Драйвер тача AXS5106L
├── include/
│   └── lv_conf.h        # Конфигурация LVGL 8.4
└── platformio.ini       # Конфигурация сборки (два окружения)
```

## Зависимости

### Контроллер
- [LVGL 8.4](https://lvgl.io/) — фреймворк сенсорного UI
- [Arduino_GFX 1.6.5](https://github.com/moononournation/Arduino_GFX) — драйвер дисплея
- [FastLED 3.9](https://fastled.io/) — статусный NeoPixel

### Приёмник
- Только встроенные компоненты ESP-IDF (ESP-NOW, WiFi, Preferences)

## Лицензия

Этот проект с открытым исходным кодом. Подробности в файле [LICENSE](../LICENSE).
