# Контролер освiтлення RC

[English](../README.md) | [Polski](README_PL.md) | [Deutsch](README_DE.md) | [Francais](README_FR.md) | [Русский](README_RU.md) | **Українська**

Бездротовий контролер освiтлення для RC-автомобiлiв та вантажiвок. Ручний пульт з сенсорним екраном (TX) зв'язується через ESP-NOW з приймачем (RX), встановленим на моделi, для керування кiлькома свiтловими виходами в реальному часi.

## Можливостi

- **5 незалежних свiтлових каналiв**: ближнє свiтло, дальнє свiтло, протитуманнi фари, свiтлова балка, аварiйна сигналiзацiя
- **Сенсорний iнтерфейс**: сiтка кнопок 2x3 на кольоровому дисплеї 1,47" з LVGL
- **Бездротовий зв'язок ESP-NOW**: протокол з низькою затримкою — WiFi-роутер не потрiбен
- **Автоматичне сполучення**: сполучення однiєю кнопкою зi збереженням у NVS
- **Блокування безпеки**: дальнє свiтло потребує ввiмкненого ближнього; аварiйний режим вимикає всi вогнi через 30 с без сигналу
- **Монiторинг з'єднання**: heartbeat-и, пiдтвердження команд через ACK, статусний NeoPixel
- **Тестовий режим**: контролер працює автономно без приймача

## Обладнання

### Контролер (TX)

| Компонент | Опис |
|-----------|------|
| Плата | [Waveshare ESP32-C6-Touch-LCD-1.47-M](https://www.waveshare.com/wiki/ESP32-C6-Touch-LCD-1.47) |
| MCU | ESP32-C6 (RISC-V, 8 МБ flash) |
| Дисплей | 1,47" JD9853, 172x320, повернутий у 320x172 альбомну орiєнтацiю |
| Тач | AXS5106L ємнiсний (I2C @ 0x63) |
| Статусний LED | WS2812 NeoPixel на GPIO8 |

### Приймач (RX)

| Компонент | Опис |
|-----------|------|
| Плата | Будь-яка плата ESP32 (класичний Xtensa) |
| Свiтловi виходи | 5x GPIO, активний-ВИСОКИЙ |
| Статусний LED | Вбудований LED на GPIO2 |
| Сполучення | Кнопка BOOT (GPIO0) — утримувати при ввiмкненнi |

### Пiдключення приймача

Пiдключiть GPIO ESP32 до ваших вогнiв через вiдповiднi драйвери (MOSFET-и, реле або LED-драйвери) залежно вiд напруги та струму. Всi виходи активнi при високому рiвнi (логiка 3,3 В).

| GPIO | Функцiя |
|------|---------|
| 16 | Протитуманнi фари |
| 17 | Ближнє свiтло |
| 18 | Дальнє свiтло |
| 19 | Свiтлова балка |
| 21 | Аварiйна сигналiзацiя |
| 2 | Статусний LED |
| 0 | Кнопка сполучення (BOOT) |

## Збiрка та прошивка

### Вимоги

- [PlatformIO](https://platformio.org/) (CLI або плагiн для IDE)
- USB-кабелi для обох плат

### Збiрка

```bash
# Збiрка прошивки контролера (TX)
pio run -e controller

# Збiрка прошивки приймача (RX)
pio run -e receiver
```

### Прошивка

```bash
# Прошити контролер
pio run -e controller -t upload

# Прошити приймач
pio run -e receiver -t upload
```

### Послiдовний монiтор

```bash
pio device monitor    # 115200 бод
```

## Сполучення

1. Увiмкнiть **приймач**, утримуючи **кнопку BOOT** (GPIO0). Статусний LED блимне 3 рази, пiдтверджуючи режим сполучення.
2. На **контролерi** вiдкрийте **Налаштування** та натиснiть **Почати сполучення**.
3. Пристрої обмiнюються MAC-адресами через ESP-NOW broadcast та зберiгають їх у NVS.
4. Перезавантажте обидва пристрої. Сполучення зберiгається i переживає перезавантаження.

## Протокол

Зв'язок використовує ESP-NOW з упакованими C-структурами (`__attribute__((packed))`) для крос-архiтектурної сумiсностi (RISC-V контролер / Xtensa приймач).

| Повiдомлення | Напрямок | Призначення |
|--------------|----------|-------------|
| `LightCommand` | TX -> RX | Задати стан вогнiв (5-бiтна маска) |
| `LightAck` | RX -> TX | Пiдтвердити поточний стан |
| `Heartbeat` | RX -> TX | Пiдтримання зв'язку (кожнi 2 с) |
| `StateReport` | RX -> TX | Повний стан + час роботи |
| `PairRequest` | TX -> RX | Запит сполучення (broadcast) |
| `PairResponse` | RX -> TX | Вiдповiдь сполучення з MAC |

### Бiтова маска вогнiв

| Бiт | Свiтло |
|-----|--------|
| 0 | Протитуманнi фари |
| 1 | Ближнє свiтло |
| 2 | Дальнє свiтло |
| 3 | Свiтлова балка |
| 4 | Аварiйна сигналiзацiя |

### Таймiнги

| Параметр | Значення |
|----------|----------|
| Таймаут ACK | 200 мс |
| Макс. повторiв | 3 |
| Iнтервал heartbeat | 2 с |
| Таймаут з'єднання (TX) | 6 с |
| Таймаут аварiйного режиму (RX) | 30 с |

## Структура проекту

```
light_controller/
├── src/
│   ├── controller/      # TX: дисплей, тач, LVGL UI, ESP-NOW TX
│   └── receiver/        # RX: GPIO-виходи, ESP-NOW RX, аварiйний режим
├── lib/
│   ├── protocol/        # Спiльнi визначення протоколу
│   └── axs5106l_touch/  # Драйвер тача AXS5106L
├── include/
│   └── lv_conf.h        # Конфiгурацiя LVGL 8.4
└── platformio.ini       # Конфiгурацiя збiрки (два оточення)
```

## Залежностi

### Контролер
- [LVGL 8.4](https://lvgl.io/) — фреймворк сенсорного UI
- [Arduino_GFX 1.6.5](https://github.com/moononournation/Arduino_GFX) — драйвер дисплея
- [FastLED 3.9](https://fastled.io/) — статусний NeoPixel

### Приймач
- Тiльки вбудованi компоненти ESP-IDF (ESP-NOW, WiFi, Preferences)

## Лiцензiя

Цей проект з вiдкритим вихiдним кодом. Деталi у файлi [LICENSE](../LICENSE).
